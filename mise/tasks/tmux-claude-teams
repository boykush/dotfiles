#!/bin/bash
#MISE description="Start tmux with Claude Agent Teams"
#MISE dir="{{cwd}}"

SESSION_NAME="claude-teams"

# Select repository directory via zoxide
TARGET_DIR=$(zoxide query -i) || exit 0
REPO_NAME=$(basename "$TARGET_DIR")

CLAUDE_CMD="CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 mise exec -- claude --teammate-mode tmux"
WINDOW_NAME="${REPO_NAME}-${RANDOM}"

if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    tmux new-window -t "$SESSION_NAME" -n "$WINDOW_NAME" -c "$TARGET_DIR" "$CLAUDE_CMD"
    [ -z "$TMUX" ] && tmux attach-session -t "$SESSION_NAME"
else
    tmux new-session -d -s "$SESSION_NAME" -n "$WINDOW_NAME" -c "$TARGET_DIR" "$CLAUDE_CMD"
    # C-j C-t で新しいClaudeセッションウィンドウを追加 (このセッション内のみ)
    tmux bind C-t if-shell '[ "$(tmux display-message -p "#S")" = "claude-teams" ]' \
        'new-window "mise run tmux-claude-teams"'
    tmux attach-session -t "$SESSION_NAME"
fi
